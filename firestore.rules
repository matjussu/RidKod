rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Collection de profils utilisateur
    match /users/{userId} {
      // Autoriser la lecture uniquement pour le propriétaire du profil
      // (Pour un leaderboard, créer une collection /leaderboard séparée avec données publiques limitées)
      allow read: if request.auth != null && request.auth.uid == userId;

      // Autoriser la création uniquement si :
      // 1. L'utilisateur est authentifié
      // 2. Le document créé a le même userId que l'utilisateur
      // 3. Les champs obligatoires sont présents
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.username.size() <= 15
                    && request.resource.data.avatarColor is string
                    && request.resource.data.email is string;

      // Autoriser la mise à jour uniquement si :
      // 1. L'utilisateur est authentifié
      // 2. L'utilisateur modifie SON propre profil
      // 3. L'email ne peut pas être modifié
      allow update: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.email == resource.data.email
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.username.size() <= 15;

      // Interdire la suppression (garder historique)
      allow delete: if false;
    }

    // Collection de progression utilisateur
    match /progress/{userId} {
      // Autoriser la lecture uniquement pour le propriétaire
      // (Pour un leaderboard, créer une collection /leaderboard séparée avec données publiques limitées)
      allow read: if request.auth != null && request.auth.uid == userId;

      // Autoriser la création uniquement si :
      // 1. L'utilisateur est authentifié
      // 2. Le document créé a le même userId que l'utilisateur
      // 3. Les champs obligatoires sont présents
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.userId == userId
                    && request.resource.data.totalXP is number
                    && request.resource.data.userLevel is number
                    && request.resource.data.currentLevel is number;

      // Autoriser la mise à jour uniquement si :
      // 1. L'utilisateur est authentifié
      // 2. L'utilisateur modifie SES propres données
      // 3. Le userId ne peut pas être modifié
      // 4. Validation basique des données
      // 5. dailyActivity est un map (objet) optionnel
      allow update: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.userId == userId
                    && request.resource.data.totalXP >= 0
                    && request.resource.data.userLevel >= 1
                    && request.resource.data.userLevel <= 10
                    && (!request.resource.data.keys().hasAny(['dailyActivity'])
                        || request.resource.data.dailyActivity is map);

      // Interdire la suppression (garder historique)
      allow delete: if false;
    }

    // Collection des scores quotidiens (Défi du jour)
    match /daily_scores/{date} {
      // Lecture publique du document parent (pour les requêtes de collection)
      allow read: if true;

      // Sous-collection des scores
      match /scores/{oderId} {
        // Lecture publique pour afficher le classement (données non sensibles)
        allow read: if true;

        // Création uniquement si l'utilisateur crée son propre score
        allow create: if request.auth != null
                      && request.auth.uid == oderId
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.score is number
                      && request.resource.data.correctAnswers is number;

        // Pas de mise à jour (un seul essai par jour)
        allow update: if false;

        // Pas de suppression
        allow delete: if false;
      }
    }

    // Collection des duels (Mode Duel)
    match /duels/{duelCode} {
      // Lecture pour tous les utilisateurs authentifiés (pour rejoindre un duel)
      allow read: if request.auth != null;

      // Création uniquement par un utilisateur authentifié
      allow create: if request.auth != null
                    && request.resource.data.host.oderId == request.auth.uid
                    && request.resource.data.code is string
                    && request.resource.data.status == 'waiting';

      // Mise à jour par les participants du duel
      allow update: if request.auth != null
                    && (resource.data.host.oderId == request.auth.uid
                        || (resource.data.guest != null && resource.data.guest.oderId == request.auth.uid)
                        || (resource.data.guest == null && request.resource.data.guest.oderId == request.auth.uid));

      // Suppression uniquement par l'hôte
      allow delete: if request.auth != null
                    && resource.data.host.oderId == request.auth.uid;
    }

    // Bloquer tout accès aux autres collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
